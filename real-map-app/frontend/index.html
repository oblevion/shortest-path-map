<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Delhi Shortest Path</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body, #map {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: sans-serif;
    }

    #infoBox {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
      max-width: 280px;
    }

    #status {
      margin-top: 6px;
      font-size: 13px;
    }

    button {
      margin-top: 8px;
      width: 100%;
      padding: 6px 0;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div id="infoBox">
    <div><strong>Delhi Shortest Path</strong></div>
    <div>Click once for origin and once for destination.</div>
    <div id="status">Click on the map to set origin.</div>
    <button id="resetBtn">Reset points</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    let map;
    let originMarker = null;
    let destMarker = null;
    let routeLine = null;
    let origin = null;
    let dest = null;
    let isFetching = false;

    function initMap() {
      map = L.map("map").setView([28.6139, 77.2090], 12);

      // Use Carto Light tiles for better reliability
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        subdomains: "abcd",
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      map.on("click", onMapClick);

      // Fix map tiles after window load
      window.addEventListener("load", () => {
        map.invalidateSize(true);
      });
    }

    function addMarker(lat, lng, label) {
      return L.marker([lat, lng]).addTo(map).bindPopup(label).openPopup();
    }

    function onMapClick(e) {
      const { lat, lng } = e.latlng;
      const status = document.getElementById("status");

      if (isFetching) {
        status.textContent = "Fetching route... please wait.";
        return;
      }

      if (!origin) {
        origin = { lat, lng };
        if (originMarker) map.removeLayer(originMarker);
        originMarker = addMarker(lat, lng, "Origin");
        status.textContent = `Origin: ${lat.toFixed(5)}, ${lng.toFixed(5)}. Now click destination.`;
      } else if (!dest) {
        dest = { lat, lng };
        if (destMarker) map.removeLayer(destMarker);
        destMarker = addMarker(lat, lng, "Destination");
        status.textContent = `Destination: ${lat.toFixed(5)}, ${lng.toFixed(5)}. Fetching route...`;
        fetchRoute();
      } else {
        status.textContent = "Both points are set. Click Reset to choose again.";
      }
    }

    async function fetchRoute() {
      if (!origin || !dest) return;
      isFetching = true;
      const status = document.getElementById("status");

      try {
        const url = `${API_BASE}/route?orig_lat=${origin.lat}&orig_lon=${origin.lng}&dest_lat=${dest.lat}&dest_lon=${dest.lng}`;
        const res = await fetch(url);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Route fetch error");
        }

        const data = await res.json();
        const coords = data.coords;
        const lengthM = data.length_m;

        if (!coords || coords.length === 0) {
          status.textContent = "No route found. Resetting in 3 seconds...";
          setTimeout(resetPoints, 3000);
          return;
        }

        if (routeLine) map.removeLayer(routeLine);

        const latlngs = coords.map(c => [c[0], c[1]]);
        routeLine = L.polyline(latlngs, { color: "blue", weight: 5 }).addTo(map);
        map.fitBounds(routeLine.getBounds());

        status.textContent = `Route length: ${(lengthM / 1000).toFixed(2)} km. Click Reset to try another pair.`;
      } catch (e) {
        status.textContent = "Error: " + e.message;
      } finally {
        isFetching = false;
      }
    }

    function resetPoints() {
      origin = null;
      dest = null;
      if (originMarker) map.removeLayer(originMarker);
      if (destMarker) map.removeLayer(destMarker);
      if (routeLine) map.removeLayer(routeLine);
      originMarker = destMarker = routeLine = null;
      document.getElementById("status").textContent = "Click on the map to set origin.";
    }

    document.getElementById("resetBtn").addEventListener("click", resetPoints);

    initMap();
  </script>
</body>
</html>
